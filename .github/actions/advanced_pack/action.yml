name: Advanced pack

inputs:
  working_directory:
    required: true
  # Supported formats:
  # ./Path
  # Path
  project_directory:
    required: true
  nuget_name:
    required: true
  nuget_version:
    required: true
  configuration:
    required: true
  output_path:
    required: true

runs:
  using: composite
  steps:
    - name: Use NuGet 6.7.x
      uses: nuget/setup-nuget@v1
      with:
        nuget-version: '6.7.x'

    - name: Regular pack
      shell: bash
      run: |
        cd ${{ inputs.working_directory }}
        version=${{ inputs.nuget_version }}
        echo "Starting default pack.."
        nuget pack ${{ inputs.project_directory }} -Build -IncludeReferencedProjects -Properties Configuration=${{ inputs.configuration }} -Symbols -OutputDirectory ${{ inputs.output_path }} -Version $version

    - name: Prepare nuspec
      shell: bash
      run: |
        # TODO: skip if the nuspec already exists
        echo "Prepare nuspec.."
        artifacts=${{ inputs.output_path }}
        unzipped_artifacts="${artifacts}_unzipped"
        echo "Unzipped artifacts path: $unzipped_artifacts"
        cp -r $artifacts $unzipped_artifacts
        cd $unzipped_artifacts
        for file in *.symbols.nupkg; do
          if [ -e "$file" ]; then
            echo "Unzipping $file..."
            unzip -o "$file" -d . 
          fi
        done
        echo "Nupkg for processing: $file"
        version=${{ inputs.nuget_version }}
        nuspec_file="${file%.$version.symbols.nupkg}.nuspec"
        if [ ! -f $nuspec_file ]; then
          echo "Nuspec $nuspec_file has not been found"
          exit 1
        fi
        nuget_name=${{ inputs.nuget_name }}
        # update package name
        echo "Nuget name: $nuget_name"
        #sed -i "s/\(<id>\)[^<]*\(<\/id>\)/\1${nuget_name}\2/" $nuspec_file
        xmlstarlet ed -u "//id" -v "$nuget_name" "$nuspec_file" > updated_file && mv updated_file "$nuspec_file"
        # update description
        git_description=$(git show --summary)
        echo "Git description: $git_description"
        # sed -i "s#\(<description>\)[^<]*\(<\/description>\)#\1${git_description}\2#" $nuspec_file
        cat $nuspec_file
        project_directory=${{ inputs.project_directory }}
        nuspec_destination=${GITHUB_WORKSPACE%/}/${project_directory#./}
        echo -e "\nNuspec destination: $nuspec_destination"
        cp $nuspec_file $nuspec_destination
        echo "nuspec_destination=${nuspec_destination}" >> $GITHUB_ENV

    - name: Update nuspec file using PowerShell
      shell: pwsh
      run: |
        cd ${{ inputs.working_directory }}
        nuspec_Destination=${{ env.nuspec_destination }}
        Write-Host "Nuspec destination: $nuspec_Destination"
        # $nuspecFiles = Get-ChildItem -Path $nuspec_Destination -Filter *.nuspec -File
        # if (!$nuspecFiles) {
        #     Write-Host "Nuspec file has not been found in $nuspecFiles"
        #     exit 1
        # }
    #     # Define the path to your nuSpec file (adjust if necessary)
    #     $xmlPath = Join-Path -Path $PSScriptRoot -ChildPath "SPZipper/SPZipper.nuspec"
    #     if (-not (Test-Path $xmlPath)) {
    #         throw "Error: The file path '$($xmlPath)' does not exist."
    #     }
    #     # Load the XML document
    #     [xml]$xmlDoc = Get-Content -Raw  $xmlPath
    #     # Create a namespace manager for the default namespace
    #     $nsMgr = New-Object System.Xml.XmlNamespaceManager($xmlDoc.NameTable)
    #     $nsMgr.AddNamespace("ns", "http://schemas.microsoft.com/packaging/2012/06/nuspec.xsd")
    #     # Update the <id> node
    #     $idNode = $xmlDoc.SelectSingleNode("//ns:metadata/ns:id", $nsMgr)
    #     if ($idNode -ne $null) {
    #         $idNode.InnerText = ${{ inputs.nuget_name }}
    #         Write-Host "<id> has been found: $($idNode.InnerText)."
    #     } else {
    #         Write-Host "<id> node not found."
    #     }

    #     # Update the <description> node (supports multi-line text)
    #     $descriptionNode = $xmlDoc.SelectSingleNode("//ns:metadata/ns:description", $nsMgr)
    #     if ($descriptionNode -ne $null) {
    #         $descriptionNode.InnerText = "This is line 1
    #     This is line 2
    #     This is line 3"
    #     } else {
    #         Write-Host "<description> node not found."
    #     }


    #     # Save the updated XML back to the file
    #     $xmlDoc.Save($xmlPath)
    #     Write-Host "XML document updated successfully!."

    # - name: Custom pack
    #   shell: bash
    #   run: |
    #     cd ${{ inputs.working_directory }}
    #     project_directory=${{ inputs.project_directory }}
    #     if ! ls $project_directory/*.nuspec >/dev/null 2>&1; then
    #       echo "Error: Nuspec file must exist in ${project_directory}" >&2
    #       exit 1
    #     fi
    #     version=${{ inputs.nuget_version }}
    #     echo "Starting custom pack.."
    #     nuget pack $project_directory -Build -IncludeReferencedProjects -Properties Configuration=${{ inputs.configuration }} -Symbols -OutputDirectory ${{ inputs.output_path }} -Version $version
 